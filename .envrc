# # Optional helper from nix-direnv, if the integration is installed.
# if type nix_direnv_manual_reload >/dev/null 2>&1; then
#   nix_direnv_manual_reload
# fi

# # Direnv executes .envrc in a non-interactive shell; Nix may be installed
# # but missing from PATH in that context.
# if ! command -v nix >/dev/null 2>&1; then
#   for p in /nix/var/nix/profiles/default/bin /nix/profile/bin "$HOME/.nix-profile/bin"; do
#     if [ -x "$p/nix" ]; then
#       PATH="$p:$PATH"
#       break
#     fi
#   done
# fi

# if ! command -v nix >/dev/null 2>&1; then
#   echo "direnv: nix binary not found on PATH (looked in /nix/var/nix/profiles/default/bin, /nix/profile/bin, ~/.nix-profile/bin)" >&2
#   return 0
# fi

# Avoid overlapping `use flake` evaluations when multiple direnv hooks
# trigger concurrently (shell prompt + IDE integration, multiple tabs).
if command -v flock >/dev/null 2>&1; then
  mkdir -p "$PWD/.direnv"
  exec 9>"$PWD/.direnv/use-flake.lock"
  if ! flock -w 1 9; then
    echo "direnv: another flake evaluation is in progress; retrying on next prompt" >&2
    return 0
  fi
fi

use flake
